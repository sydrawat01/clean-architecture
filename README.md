# Clean Architecture

## Initialization

Create a new folder `clean-architecture`. Run the commands to initialize `git` and `yarn package manager`.

> NOTE: You can use `npm` as a package manager as well, instead of `yarn`.

### git

```shell
git init
```

### Package Manager

```shell
# npm
npm init -y
# yarn
yarn init -y
```

## Folder Structure

This is my personal, highly opinionated folder structure for simple REST API setup.

```text
src
  |__ configs
  |__ controllers
  |__ routes
  |__ middlewares
  |__ models
  |__ utils
test
```

## `.gitignore`

Let's create the `.gitignore` file to prevent pushing ineffectual files to version control.

<details>

```.ignore
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*
.pnpm-debug.log*

# Diagnostic reports (https://nodejs.org/api/report.html)
report.[0-9]*.[0-9]*.[0-9]*.[0-9]*.json

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage
*.lcov

# nyc test coverage
.nyc_output

# Grunt intermediate storage (https://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# Snowpack dependency directory (https://snowpack.dev/)
web_modules/

# TypeScript cache
*.tsbuildinfo

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional stylelint cache
.stylelintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variable files
.env
.env.development.local
.env.test.local
.env.production.local
.env.local

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# Next.js build output
.next
out

# Nuxt.js build / generate output
.nuxt
dist

# Gatsby files
.cache/
# Comment in the public line in if your project uses Gatsby and not Next.js
# https://nextjs.org/blog/next-9-1#public-directory-support
# public

# vuepress build output
.vuepress/dist

# vuepress v2.x temp and cache directory
.temp
.cache

# Docusaurus cache and generated files
.docusaurus

# Serverless directories
.serverless/

# FuseBox cache
.fusebox/

# DynamoDB Local files
.dynamodb/

# TernJS port file
.tern-port

# Stores VSCode versions used for testing VSCode extensions
.vscode-test

# yarn v2
.yarn/cache
.yarn/unplugged
.yarn/build-state.yml
.yarn/install-state.gz
.pnp.*

# IntelliJ
.idea

# MacOS
.DS_Store

# shelf
globalConfig.json
```

</details>

## Typescript

### Install

Install typescript and Node types for typescript.

```shell
yarn add -D typescript @types/node
```

### Initialize

```shell
npx tsc --init
```

Configure the following options in the `tsconfig.json` file, along with the default configured options:

```json
{
  "compilerOptions": {
    "baseUrl": "./src",
    "paths": {
      "@configs/*": ["configs/*"],
      "@controllers/*": ["controllers/*"],
      "@middlewares/*": ["middlewares/*"],
      "@routes/*": ["routes/*"],
      "@models/*": ["models/*"],
      "@utils/*": ["utils/*"],
      "@test/*": ["../test/*"]
    },
    "rootDirs": [
      "src",
      "test"
    ],
    "outDir": "./dist",
  },
  "include": ["src", "test"],
  "exclude": []
}
```

### Build configuration

We will have a separate build configuration `tsconfig-build.json` for our typescript API:

```json
{
  "include": ["src", "test"],
  "exclude": []
}
```

## module-alias

This package helps us use deeply nested dependencies in our project easily using the `@` symbol.

```shell
yarn add module-alias
```

### Configure `module-alias`

In `package.json`:

```json
{
  // {...}
  "_moduleAliases": {
    "@configs": "dist/configs",
    "@controllers": "dist/controllers",
    "@middlewares": "dist/middlewares",
    "@routes": "dist/routes",
    "@models": "dist/models",
    "@utils": "dist/utils"
  }
  // {...}
}
```

## Helpers

We will install some helper packages that will enhance our development experience:

```shell
yarn add -D rimraf concurrently nodemon
```

## Scripts

It's time we add some scripts that help us run a dev and a build version of our application.

Let's update our `package.json` to include scripts to build our application.

```json
{
  // {...}
  "scripts": {
    "build": "rimraf dist && tsc -p tsconfig-build.json",
    "build:watch": "npm run build -- --watch",
    "start": "node dist/server.js",
    "dev": "nodemon -L --watch ./dist ./dist/server.js",
    "start:dev": "concurrently --kill-others-on-fail \"npm run build:watch\" \"npm run dev\"",
  }
  // {...}
}
```

## Jest

We will use Jest as a testing framework.

Let's install Jest:

```shell
yarn add -D jest @types/jest
```

In order to initialize Jest with default config, run the following command/script:

```shell
./node_modules/jest/bin/jest.js --init
```

This will create a new config file called `jest.config.js`. This contains the configuration for the Jest testing framework to run on your defined tests.

Additionally, we install another package to help us writing tests in TypeScript:

```shell
yarn add -D ts-jest
```

Add the following configuration to the above created file:

```js
//[...]
const { defaults: tsjPreset } = require('ts-jest/presets');
const config = {
  collectCoverageFrom: ['<rootDir>/src/**/*.ts', '!<rootDir>/src/server.ts'],
  coverageDirectory: 'coverage',
  coverageProvider: 'v8',
  moduleNameMapper: {
    '@configs/(.*)': '<rootDir>/src/configs/$1',
    '@controllers/(.*)': '<rootDir>/src/controllers/$1',
    '@middlewares/(.*)': '<rootDir>/src/middlewares/$1',
    '@models/(.*)': '<rootDir>/src/models/$1',
    '@routes/(.*)': '<rootDir>/src/routes/$1',
    '@utils/(.*)': '<rootDir>/src/utils/$1',
    '@test/(.*)': '<rootDir>/test/$1',
  },
  roots: ['<rootDir>/test/'],
  transform: {
    ...tsjPreset.transform,
  },
};

module.exports = config;
//[...]
```

### Test Scripts

Let's add some scripts to run tests using Jest in our `package.json` file:

```json
{
  // {...}
  "scripts": {
    "test": "jest --passWithNoTests --runInBand --no-cache",
    "test:staged": "npm run test -- --findRelatedTests",
    "test:ci": "npm run test -- --coverage",
  }
  // {...}
}
```

## ESLint

We will use ESLint to lint our code for any syntax errors and follow best practices for writing clean code.

```shell
npm init @eslint/config
```

Running the above command will create a new config file called `.eslintrc.json`, which contains the configuration information for running ESLint.

Add the following lines to this file:

```json
{
 //{...}
  "parserOptions": {
    "project": ["./tsconfig.json"]
  },
  "ignorePatterns": ["*.config.js"],
}
//{...}
```

### Lint Scripts

Let's add some scripts to lint our code using ESLint in our `package.json` file:

```json
{
  // {...}
  "scripts": {
    "lint": "eslint --ignore-path .gitignore --ext .ts --fix",
  }
  // {...}
}
```

## Husky + Lint Staged

Husky helps us maintain a standard of code when more people are working on the same piece of code, and to follow best practices before anyone commits their code to the main organization repositories.

```shell
npx husky-init && yarn
```

Next, add a commit message hook:

```shell
npx husky add .husky/commit-msg 'npx --no -- commitlint --edit "$1"'
```

Now let's add lint-staged as well:

```shell
yarn add -D lint-staged
```

### Configurations

Let's add some scripts and other configs t in our `package.json` file for husky and lint-staged:

```json
{
  // {...}
  "scripts": {
    "prepare": "husky install",
  },
  "lint-staged": {
    "*.ts": [
      "npm run lint",
      "npm run test:staged"
    ]
  }
  // {...}
}
```

## CommitLint

This is a configuration package to follow conventional commit message formats:

```shell
yarn add -D @commitlint/{config-conventional,cli}
```

Configure commitlint to use conventional commit message configuration:

```shell
echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
```

## Supertest

Supertest is a package that helps us run mock API requests in our test cases/scripts.

```shell
yarn add -D supertest @types/supertest
```